#!/bin/ksh --login
#------------------------------------------------------------------------------#
# batch directives
#------------------------------------------------------------------------------#
#PBS -S /bin/ksh
#PBS -A PROJECT_ACCOUNT
#PBS -N decompTestProto
#PBS -o decompTestProto.log
#PBS -j oe
#PBS -m abe
#PBS -l walltime=00:30:00
#PBS -l select=8:ncpus=32
#PBS -l place=scatter:excl
#PBS -q standard
#PBS -W umask=0027

cd $PBS_O_WORKDIR

# Load modules and setup runtime environment
#module use MODULE_FOLDER
#module load MODULE
#module list

export NP=$PBS_NP
export RUNDIR=`pwd`

# Enable FORTRAN RTL core dumps for severe run time failures
#export decfort_dump_flag=y

# Enable runtime compliance checker
#export ESMF_RUNTIME_COMPLIANCECHECK=ON:depth=4

# Enable runtime trace output
export ESMF_RUNTIME_TRACE=ON
#export ESMF_RUNTIME_TRACE_PETLIST="0"

# Set resource usage limits
ulimit -c unlimited #coredumpsize
ulimit -s unlimited #stacksize
ulimit -t unlimited #cputime
ulimit -d unlimited #datasize
ulimit -m unlimited #memoryuse

# Run application using MPI
mkdir -p $RUNDIR/nosync
cd $RUNDIR/nosync
echo "Model started nosync:  " `date`
mpirun -n 256 ../esmApp ../runconfig.nosync > run.log 2>&1
echo "Model ended nosync:    " `date`

mkdir -p $RUNDIR/sync
cd $RUNDIR/sync
echo "Model started sync:  " `date`
mpirun -n 256 ../esmApp ../runconfig.sync > run.log 2>&1
echo "Model ended sync:    " `date`

mkdir -p $RUNDIR/memcopy
cd $RUNDIR/memcopy
echo "Model started memcopy:  " `date`
mpirun -n 256 ../esmApp ../runconfig.memcopy > run.log 2>&1
echo "Model ended memcopy:    " `date`

mkdir -p $RUNDIR/error
cd $RUNDIR/error
echo "Model started error:  " `date`
mpirun -n 256 ../esmApp ../runconfig.error > run.log 2>&1
echo "Model ended error:    " `date`

exit
